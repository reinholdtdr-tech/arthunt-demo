<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARtHunt ‚Äì v2.5 (Info-Popup, Radius-Filter, Inbox)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    * { box-sizing: border-box; }
    :root {
      --fg:#111827; --muted:#6b7280; --bg:#ffffff; --card:#ffffff;
      --accent:#111827; --good:#10b981; --danger:#ef4444; --info:#2563eb; --info-fill:#93c5fd;
    }
    .fab, .fab2 { position: fixed; top: 12px; z-index: 1000; width: 44px; height: 44px; border-radius: 999px;
      background: var(--accent); color: #fff; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 28px rgba(0,0,0,.18); cursor: pointer; user-select:none; }
    .fab { right: 12px; } .fab2 { right: 62px; }
    .fab span, .fab2 span { font-size: 20px; line-height: 1; }

    .sheet { position: fixed; left: 12px; right: 12px; bottom: 12px; background: rgba(255,255,255,.96);
      backdrop-filter: blur(8px); border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.18);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow: hidden; z-index: 999; }
    .sheet-header { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; cursor:pointer; }
    .pill { width: 40px; height: 5px; border-radius: 999px; background:#e5e7eb; margin: 6px auto; }
    .title { font-weight: 700; font-size: 14px; }
    .muted { color: var(--muted); font-size: 12px; }
    .sheet-body { padding: 8px 10px; display:none; }
    .sheet.open .sheet-body { display:block; max-height: 42vh; overflow:auto; }
    .art-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; background: var(--card); }
    .btn { display:inline-block; padding: 8px 10px; border-radius: 8px; font-weight: 600; cursor: pointer; border:0; }
    .btn-primary { background: var(--accent); color: #fff; } .btn-unlocked { background: var(--good); color: #fff; } .btn-ghost { background: #f3f4f6; color:var(--fg); }
    .badge { display:inline-block; padding:2px 6px; font-size:11px; border-radius: 999px; background:#f3f4f6; }
    .settings { display:flex; gap:8px; align-items:center; justify-content:flex-end; }

    /* Unlock pulse effect */
    .pulse-pin { width: 18px; height: 18px; border-radius: 999px; background: var(--good); border:2px solid #065f46; }
    .pulse-ring { position:absolute; top:-16px; left:-16px; width: 50px; height: 50px; border:2px solid rgba(16,185,129,0.6);
      border-radius: 999px; animation: ring 800ms ease-out forwards; }
    @keyframes ring { from { transform: scale(.1); opacity: .9; } to { transform: scale(1.3); opacity: 0; } }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 1000;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; } .modal.open { display: flex; }
    .modal-card { background: #111; color: #fff; border-radius: 16px; padding: 16px; max-width: min(720px, 92vw); box-shadow: 0 16px 48px rgba(0,0,0,.45); position: relative; }
    .modal-card img { max-width: 100%; border-radius: 12px; display: block; margin: 8px auto; }
    .close { position: absolute; top: 12px; right: 12px; background: #fff; color:#111; border:0; border-radius: 8px; padding: 8px 10px; cursor:pointer; }
    .modal-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip { font-size:12px; background:#1f2937; padding:6px 8px; border-radius:999px; }
    .comment { background:#0f172a; border-radius:8px; padding:6px 8px; margin-top:6px; font-size:13px; }
    .comment-reply { margin-left:16px; opacity:.92; }
    .comment-light { background:#fff; color:#111; border:1px solid #e5e7eb;
      border-radius:8px; padding:6px 8px; margin-top:6px; font-size:13px; }

    .drawer { position: fixed; top:0; right:0; bottom:0; width: min(520px, 94vw); background:#fff; z-index:1001;
      box-shadow: -8px 0 28px rgba(0,0,0,.25); transform: translateX(100%); transition: transform .25s ease; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .drawer.open { transform: translateX(0); } .drawer header { padding: 12px; display:flex; align-items:center; justify-content:space-between; border-bottom: 1px solid #e5e7eb; }
    .drawer h2 { font-size: 16px; margin:0; }
    .tabs { display:flex; gap:6px; padding:8px; border-bottom:1px solid #e5e7eb; }
    .tabs button { padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .tabs button.active { background:#111827; color:#fff; border-color:#111827; }
    .panel { display:none; padding:12px; overflow:auto; height: calc(100% - 96px); }
    .panel.active { display:block; }
    .field { margin-bottom: 10px; } .field label { display:block; font-size:12px; color:#374151; margin-bottom: 4px; }
    .field input, .field textarea { width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .preview { border:1px dashed #e5e7eb; border-radius: 10px; padding:8px; text-align:center; } .preview img { max-width:100%; border-radius:8px; }
    .list { display:grid; gap:10px; } .item { border:1px solid #e5e7eb; padding:8px; border-radius:8px; }
    .layer-row { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:8px; }
    .legend-swatch { width:14px; height:14px; border-radius:999px; }

    /* compacter previews */
    #commentList .comment { max-height: 72px; overflow: hidden; }
    #infoComments .comment { max-height: 56px; overflow:hidden; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="fab2" id="menuBtn" title="Men√º & Creator"><span>‚ò∞</span></div>
  <div class="fab" id="centerBtn" title="Auf mich zentrieren"><span>‚óé</span></div>

  <div class="sheet" id="sheet">
    <div class="pill"></div>
    <div class="sheet-header" id="toggleSheet">
      <div>
        <div class="title">ARtHunt</div>
        <div class="muted" id="status">Standort: wird ermittelt‚Ä¶</div>
      </div>
      <div class="settings">
        <label class="muted" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="autoOpen" checked /> Auto-√ñffnen vor Ort
        </label>
      </div>
    </div>
    <div class="sheet-body">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="muted">Gefunden:</div><div><span class="badge" id="progress">0 / 0</span></div>
      </div>
      <div id="art-list" style="margin-top:8px; display:grid; gap:8px;"></div>
    </div>
  </div>

  <aside class="drawer" id="drawer">
    <header>
      <h2>Men√º</h2>
      <button class="btn btn-ghost" id="closeDrawer">Schlie√üen</button>
    </header>
    <div class="tabs">
      <button class="tab-btn active" data-tab="create">Ôºã Create</button>
      <button class="tab-btn" data-tab="layers">üéöÔ∏è Layers</button>
      <button class="tab-btn" data-tab="activity">üí¨ Aktivit√§t</button>
      <button class="tab-btn" data-tab="settings">‚öôÔ∏è Einstellungen</button>
    </div>

    <!-- Create -->
    <section class="panel active" id="panel-create">
      <h3 style="margin:6px 0 10px 0;">Neues Werk vor Ort erfassen</h3>
      <div class="field grid2">
        <div><label>Titel</label><input id="fTitle" placeholder="Titel des Werks" /></div>
        <div><label>K√ºnstler</label><input id="fArtist" placeholder="Name oder Kollektiv" /></div>
      </div>
      <div class="field grid2">
        <div><label>Radius (m)</label><input id="fRadius" type="number" min="10" max="300" value="60" /></div>
        <div><label>Koordinaten</label><input id="fCoords" placeholder="Lat, Lon" /></div>
      </div>
      <div class="field"><label>Beschreibung</label><textarea id="fDesc" rows="3" placeholder="Kurze Beschreibung‚Ä¶"></textarea></div>
      <div class="field"><label>Bild (lokal in Base64)</label><input id="fImage" type="file" accept="image/*" /></div>
      <div class="field"><label>Externer Link (Spotify, YouTube, SoundCloud, Website ‚Ä¶)</label><input id="fMediaLink" placeholder="https://‚Ä¶"/></div>
      <div class="preview" id="imgPreview">Noch kein Bild ausgew√§hlt.</div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="btn btn-primary" id="btnUseHere">Meine aktuelle Position setzen</button>
        <button class="btn btn-unlocked" id="btnAdd">Entwurf speichern</button>
      </div>
      <hr style="margin:14px 0;">
      <h3 style="margin:6px 0 10px 0;">Meine Entw√ºrfe (lokal)</h3>
      <div class="list" id="draftList"></div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="btn btn-primary" id="btnExport">Als JSON exportieren</button>
        <button class="btn btn-ghost" id="btnClear">Entw√ºrfe l√∂schen</button>
      </div>
      <p class="muted" style="margin-top:8px;">
        Hinweis: Entw√ºrfe werden nur lokal gespeichert. Lade die exportierte <code>submissions.json</code> ins Repo hoch
        oder merge sie in <code>artworks.json</code>. Zus√§tzlich l√§dt die App optional eine serverseitige <code>submissions.json</code> als ‚Äûblauen Layer‚Äú.
      </p>
    </section>

    <!-- Layers -->
    <section class="panel" id="panel-layers">
      <h3 style="margin:6px 0 10px 0;">Layers & Legende</h3>
      <div class="layer-row">
        <div class="legend-swatch" style="background: var(--danger);"></div>
        <label style="flex:1">Live ‚Äì verschlossen</label>
        <input type="checkbox" id="toggleLocked" checked />
      </div>
      <div class="layer-row">
        <div class="legend-swatch" style="background: var(--good);"></div>
        <label style="flex:1">Live ‚Äì freigeschaltet</label>
        <input type="checkbox" id="toggleUnlocked" checked />
      </div>
      <div class="layer-row">
        <div class="legend-swatch" style="background: var(--info-fill);"></div>
        <label style="flex:1">Entw√ºrfe ‚Äì lokal</label>
        <input type="checkbox" id="toggleDraftsLocal" checked />
      </div>
      <div class="layer-row">
        <div class="legend-swatch" style="background: #60a5fa;"></div>
        <label style="flex:1">Entw√ºrfe ‚Äì server (submissions.json)</label>
        <input type="checkbox" id="toggleDraftsServer" checked />
      </div>
      <div class="layer-row" style="flex-direction:column; align-items:stretch">
        <label><b>Umkreis f√ºr die Liste</b> (1‚Äì200 km): <span id="radiusLabel">5 km</span></label>
        <input type="range" id="listRadius" min="1" max="200" value="5" />
        <div class="muted" style="font-size:12px">Gilt nur f√ºr die Liste. Karte bleibt unver√§ndert.</div>
      </div>
    </section>

    <!-- Activity -->
    <section class="panel" id="panel-activity">
      <h3 style="margin:6px 0 10px 0;">Aktivit√§t (lokal)</h3>
      <div id="activity"></div>
      <h4 style="margin:12px 0 6px;">Kommentare zu meinen Werken</h4>
      <div id="inbox" class="list"></div>
      <p class="muted" style="margin-top:8px;">Sp√§ter mit Login/Cloud ‚Äì aktuell nur auf diesem Ger√§t gespeichert.</p>
    </section>

    <!-- Settings -->
    <section class="panel" id="panel-settings">
      <h3 style="margin:6px 0 10px 0;">Einstellungen</h3>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="btn btn-ghost" id="btnInstallPWA">Als App installieren</button>
        <button class="btn btn-ghost" id="btnClearLocal">Lokale Daten l√∂schen</button>
      </div>
    </section>
  </aside>

  <!-- Big artwork modal -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <button class="close" onclick="closeModal()">Schlie√üen</button>
      <div style="font-weight:700;margin-bottom:4px;" id="modal-title"></div>
      <div style="opacity:.8;margin-bottom:6px;" id="modal-artist"></div>
      <img id="modal-img" alt="Artwork" onerror="this.onerror=null;this.src='https://picsum.photos/seed/arthunt/1200/800';" />
      <div id="modal-desc" style="opacity:.9;margin-top:8px;"></div>
 <div class="modal-actions">
  <button class="btn btn-ghost" id="btnLike">‚ù§Ô∏è <span id="likeCount">0</span></button>
  <button class="btn btn-ghost" id="btnShare">‚ÜóÔ∏è Teilen</button>

  <!-- NEU: Play-Button f√ºr externe Medien (Spotify, YouTube usw.) -->
  <button class="btn btn-ghost" id="btnPlay" style="display:none">‚ñ∂Ô∏è Abspielen</button>

  <button class="btn btn-ghost" id="btnAllCommentsBig">üóÇÔ∏è Alle</button>
  <button class="btn btn-ghost" id="btnAr" style="display:none">üï∂Ô∏è In AR ansehen</button>
  <button class="btn btn-ghost" id="btnArGeo" style="display:none">üìç Am Ort in AR</button>
</div>
      <div id="commentList"></div>
      <div style="display:flex; gap:6px; margin-top:8px;">
        <input id="commentInput" placeholder="Kommentar hinzuf√ºgen‚Ä¶" style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:#fff;" />
        <button class="btn btn-unlocked" id="commentSend">Senden</button>
      </div>
      <div style="margin-top:8px;">
        <button class="btn btn-ghost" id="btnClaim">Als Creator verwalten</button>
        <span id="ownedBadge" class="chip" style="display:none; margin-left:6px;">üëë Du verwaltest dieses Werk</span>
      </div>
    </div>
  </div>

  <!-- Full comments modal -->
  <div class="modal" id="commentsModal">
    <div class="modal-card" style="max-width:min(560px,92vw);">
      <button class="close" onclick="document.getElementById('commentsModal').classList.remove('open')">Schlie√üen</button>
      <div style="font-weight:700;margin-bottom:6px;">Alle Kommentare</div>
      <div id="allCommentsList" style="max-height:60vh; overflow:auto;"></div>
    </div>
  </div>

  <!-- Locked info modal -->
  <div class="modal" id="infoModal">
    <div class="modal-card" style="max-width:min(560px,92vw);">
      <button class="close" onclick="document.getElementById('infoModal').classList.remove('open')">Schlie√üen</button>
      <div id="infoTitle" style="font-weight:700;margin-bottom:2px;"></div>
      <div id="infoArtist" style="opacity:.8;margin-bottom:6px;"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;">
        <span class="chip" id="infoDist"></span>
        <span class="chip" id="infoNeed"></span>
        <span class="chip">‚ù§Ô∏è <span id="infoLikes">0</span></span>
      </div>
      <div id="infoComments"></div>
      <div class="modal-actions" style="margin-top:10px;">
        <button class="btn btn-ghost" id="btnAllComments">Alle Kommentare</button>
        <button class="btn btn-primary" id="btnRoute">Route</button>
        <button class="btn btn-ghost" id="btnClaimInfo">Zu meinen Werken</button>
      </div>
      <p class="muted" style="margin-top:6px;">Du bist au√üerhalb des Radius. Auto-√ñffnen vor Ort ist aktiv, wenn du es oben eingeschaltet hast.</p>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    const DEFAULT_CENTER = [53.707, 9.996];
    const DEFAULT_ZOOM = 15;
    const STORAGE_UNLOCK = 'arthunt_unlocked_v2_5';
    const STORAGE_DRAFTS = 'arthunt_drafts_v2_5';
    const STORAGE_LIKES = 'arthunt_likes_v2_5';
    const STORAGE_COMMENTS = 'arthunt_comments_v2_5';
    const STORAGE_LIST_RADIUS = 'arthunt_list_radius_km_v2_5';
    const STORAGE_OWNED = 'arthunt_owned_ids_v2_5';

  const DEFAULT_ARTWORKS = [
  {
    id: 'nms',
    title: 'Norderstedt Mitte Rose',
    artist: 'Studio X',
    lat: 53.7067,
    lon: 9.9959,
    radius: 60,
    image: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
    description: 'Black stencil grenade with a blooming red rose at Norderstedt Mitte.',
    ar: {
      glb: 'https://modelviewer.dev/shared-assets/models/Astronaut.glb',
      usdz: 'https://modelviewer.dev/shared-assets/models/Astronaut.usdz',
      scale: 100,
      rot: 0
    }
  },
  {
    id:'stadtpark',
    title:'Heartbeat im Stadtpark',
    artist:'A. Miro',
    lat:53.7140,
    lon:10.0060,
    radius:80,
    image:'https://images.unsplash.com/photo-1496317556649-f930d733eea6?q=80&w=1200&auto=format&fit=crop',
    description:'City skyline morphing into a red heartbeat line near dem See im Stadtpark.'
  },
  {
    id:'moorbek',
    title:'Red Umbrella Moorbekpassage',
    artist:'Mira K.',
    lat:53.7080,
    lon:9.9915,
    radius:70,
    image:'https://images.unsplash.com/photo-1491955478222-69ae25414368?q=80&w=1200&auto=format&fit=crop',
    description:'Silhouette mit rotem Schirm; rote Tropfen formen Herzen bei der Moorbekpassage.'
  }
];

    // State
    let artworks = [];
    const unlocked = JSON.parse(localStorage.getItem(STORAGE_UNLOCK) || '{}');
    let draftsLocal = JSON.parse(localStorage.getItem(STORAGE_DRAFTS) || '[]');
    let draftsServer = []; // submissions.json from server (optional)
    const likes = JSON.parse(localStorage.getItem(STORAGE_LIKES) || '{}'); // {id: count}
    const comments = JSON.parse(localStorage.getItem(STORAGE_COMMENTS) || '{}'); // {id: [{text, at}]}
    let LIST_RADIUS_KM = parseInt(localStorage.getItem(STORAGE_LIST_RADIUS) || '5', 10);
    let ownedIds = JSON.parse(localStorage.getItem(STORAGE_OWNED) || '[]');

    function saveUnlocks(){ localStorage.setItem(STORAGE_UNLOCK, JSON.stringify(unlocked)); }
    function saveDrafts(){ localStorage.setItem(STORAGE_DRAFTS, JSON.stringify(draftsLocal)); }
    function saveLikes(){ localStorage.setItem(STORAGE_LIKES, JSON.stringify(likes)); }
    function saveComments(){ localStorage.setItem(STORAGE_COMMENTS, JSON.stringify(comments)); }
    function saveOwned(){ localStorage.setItem(STORAGE_OWNED, JSON.stringify(ownedIds)); }

    function toRad(d){return d*Math.PI/180;}
    function haversine(a,b){
      const R=6371000;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const la1=toRad(a.lat), la2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }

    // Map
    const map = L.map('map', { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    let userMarker = null;

    // Layers
    const liveLockedLayer = L.layerGroup().addTo(map);
    const liveUnlockedLayer = L.layerGroup().addTo(map);
    const draftLocalLayer = L.layerGroup().addTo(map);
    const draftServerLayer = L.layerGroup().addTo(map);

    // UI refs
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const autoOpenEl = document.getElementById('autoOpen');
    const list = document.getElementById('art-list');
    const radiusInput = document.getElementById('listRadius');
    const radiusLabel = document.getElementById('radiusLabel');

    document.getElementById('centerBtn').addEventListener('click', ()=>{
      if(userMarker){ map.setView(userMarker.getLatLng(), 16); } else alert('Standort noch nicht aktiv.');
    });

    // Sheet
    const sheet = document.getElementById('sheet');
    document.getElementById('toggleSheet').addEventListener('click', ()=> sheet.classList.toggle('open'));

    // Drawer + Tabs
    const drawer = document.getElementById('drawer');
    document.getElementById('menuBtn').addEventListener('click', ()=> drawer.classList.add('open'));
    document.getElementById('closeDrawer').addEventListener('click', ()=> drawer.classList.remove('open'));
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('panel-'+btn.dataset.tab).classList.add('active');
      });
    });

    // Layers toggles
    const toggleLocked = document.getElementById('toggleLocked');
    const toggleUnlocked = document.getElementById('toggleUnlocked');
    const toggleDraftsLocal = document.getElementById('toggleDraftsLocal');
    const toggleDraftsServer = document.getElementById('toggleDraftsServer');
    function applyLayerToggles(){
      if(toggleLocked.checked) map.addLayer(liveLockedLayer); else map.removeLayer(liveLockedLayer);
      if(toggleUnlocked.checked) map.addLayer(liveUnlockedLayer); else map.removeLayer(liveUnlockedLayer);
      if(toggleDraftsLocal.checked) map.addLayer(draftLocalLayer); else map.removeLayer(draftLocalLayer);
      if(toggleDraftsServer.checked) map.addLayer(draftServerLayer); else map.removeLayer(draftServerLayer);
    }
    [toggleLocked, toggleUnlocked, toggleDraftsLocal, toggleDraftsServer].forEach(el=> el.addEventListener('change', applyLayerToggles));

    // Radius UI
    if (radiusInput && radiusLabel) {
      radiusInput.value = LIST_RADIUS_KM;
      radiusLabel.textContent = LIST_RADIUS_KM + ' km';
      radiusInput.addEventListener('input', () => {
        LIST_RADIUS_KM = parseInt(radiusInput.value, 10);
        radiusLabel.textContent = LIST_RADIUS_KM + ' km';
        localStorage.setItem(STORAGE_LIST_RADIUS, String(LIST_RADIUS_KM));
        if (userMarker) {
          const p = userMarker.getLatLng();
          renderList({ lat: p.lat, lng: p.lng });
        } else {
          renderList(null);
        }
      });
    }

    function renderList(userLatLng){
      list.innerHTML = '';
      // sort by distance if we know it
      const arr = artworks.slice().sort((a,b) => {
        if (!userLatLng) return 0;
        const da = haversine({lat:userLatLng.lat, lon:userLatLng.lng}, {lat:a.lat, lon:a.lon});
        const db = haversine({lat:userLatLng.lat, lon:userLatLng.lng}, {lat:b.lat, lon:b.lon});
        return da - db;
      });

      arr.forEach(a=>{
        const d = (userLatLng ? Math.round(haversine({lat:userLatLng.lat, lon:userLatLng.lng}, {lat:a.lat, lon:a.lon})) : null);
        // list filter by chosen radius
        if (userLatLng && d > LIST_RADIUS_KM * 1000) return;

        const isUnlocked = !!unlocked[a.id];
        const card = document.createElement('div');
        card.className = 'art-card';
        card.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <div><div style="font-weight:700">${a.title}</div><div style="font-size:12px;color:#666">${a.artist}</div></div>
            <span class="badge">${isUnlocked ? 'Freigeschaltet' : 'Verschlossen'}</span>
          </div>
          <div style="font-size:12px;margin-top:4px">Radius: ${a.radius} m</div>
          <div style="font-size:12px">Entfernung: ${d==null ? '‚Äì' : d+' m'}</div>
          <button class="btn ${isUnlocked ? 'btn-unlocked' : 'btn-primary'}" style="margin-top:6px;width:100%">
            ${isUnlocked ? 'Ansehen' : 'Vor Ort freischalten'}
          </button>`;
        list.appendChild(card);
        card.querySelector('button').addEventListener('click', ()=>{
          if(isUnlocked) openModal(a); else tryUnlock(a, userLatLng);
        });
      });

      progressEl.textContent = `${Object.keys(unlocked).length} / ${artworks.length}`;
    }

    function wireMarkers(){
      liveLockedLayer.clearLayers(); liveUnlockedLayer.clearLayers();
      artworks.forEach(a=>{
        const isUnlocked = !!unlocked[a.id];
        const layer = isUnlocked ? liveUnlockedLayer : liveLockedLayer;
        const m = L.circleMarker([a.lat, a.lon], {
          radius: 7, color: '#111', weight: 2, fillColor: isUnlocked ? getComputedStyle(document.documentElement).getPropertyValue('--good') : getComputedStyle(document.documentElement).getPropertyValue('--danger'),
          fillOpacity: 1
        }).addTo(layer);
        m.on('click', ()=>{
          if(isUnlocked) openModal(a);
          else {
            let dist = null;
            if (userMarker) { const p = userMarker.getLatLng(); dist = Math.round(haversine({lat:p.lat, lon:p.lng}, {lat:a.lat, lon:a.lon})); }
            openLockedInfo(a, dist);
          }
        });
        a._marker = m;
      });
      applyLayerToggles();
    }

    function renderDraftMarkers(){
      draftLocalLayer.clearLayers();
      draftsLocal.forEach(d=>{
        const m = L.circleMarker([d.lat, d.lon], { radius: 7, color: '#2563eb', weight: 2, fillColor: '#93c5fd', fillOpacity: 1 }).addTo(draftLocalLayer);
        m.bindTooltip('Entwurf (lokal): ' + d.title);
        m.on('click', ()=> openModal({ id:d.id, title:d.title, artist:d.artist, image:d.image, description:d.description, mediaLink:d.mediaLink }));
      });
      draftServerLayer.clearLayers();
      draftsServer.forEach(d=>{
        const m = L.circleMarker([d.lat, d.lon], { radius: 7, color: '#1d4ed8', weight: 2, fillColor: '#60a5fa', fillOpacity: 1 }).addTo(draftServerLayer);
        m.bindTooltip('Entwurf (server): ' + d.title);
        m.on('click', ()=> openModal({ id:d.id, title:d.title, artist:d.artist, image:d.image, description:d.description, mediaLink:d.mediaLink }));
      });
      applyLayerToggles();
    }

    // Drop-signal: pulse + beep
    function unlockEffectAt(lat, lon){
      const icon = L.divIcon({ className:'', html:'<div class="pulse-pin"></div><div class="pulse-ring"></div>', iconSize:[18,18], iconAnchor:[9,9] });
      const pin = L.marker([lat, lon], {icon}).addTo(map);
      setTimeout(()=> map.removeLayer(pin), 900);
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.frequency.value = 880; o.type = 'sine'; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
        o.start(); o.stop(ctx.currentTime + 0.26);
      } catch(e) {}
    }

    function tryUnlock(a, userLatLng){
      if(!userLatLng){ alert('Position noch nicht bereit ‚Äì bitte Standortfreigabe erlauben.'); return; }
      const dist = haversine({lat:userLatLng.lat, lon:userLatLng.lon || userLatLng.lng},{lat:a.lat, lon:a.lon});
      if(dist <= a.radius){
        unlocked[a.id] = { at: Date.now() }; saveUnlocks();
        if(a._marker) a._marker.setStyle({ fillColor: getComputedStyle(document.documentElement).getPropertyValue('--good') });
        renderList(userLatLng);
        unlockEffectAt(a.lat, a.lon);
        if(autoOpenEl.checked) openModal(a);
      } else {
        openLockedInfo(a, Math.round(dist));
      }
    }

    // Modal helpers
    const modal = document.getElementById('modal');
    const likeBtn = document.getElementById('btnLike');
    const likeCountEl = document.getElementById('likeCount');
    const shareBtn = document.getElementById('btnShare');
    const playBtn = document.getElementById('btnPlay');
    const btnArGeo = document.getElementById('btnArGeo');
    const commentList = document.getElementById('commentList');
    const commentInput = document.getElementById('commentInput');
    const commentSend = document.getElementById('commentSend');
    const claimBtn = document.getElementById('btnClaim');
    const ownedBadge = document.getElementById('ownedBadge');
    let currentArtwork = null;

    function renderComments(id){
      commentList.innerHTML = '';
      const arr = comments[id] || [];
      const latest = arr.slice(-3);
      latest.forEach(c=>{
        const el = document.createElement('div'); el.className='comment'; el.textContent = c.text;
        if (Array.isArray(c.replies)) {
          c.replies.forEach(r=>{
            const rEl = document.createElement('div'); rEl.className='comment comment-reply'; rEl.textContent = '‚Ü≥ ' + r.text;
            el.appendChild(rEl);
          });
        }
        commentList.appendChild(el);
      });
      if (arr.length > 3) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-ghost'; btn.textContent = `Alle ${arr.length} Kommentare anzeigen`;
        btn.onclick = ()=> openAllComments(id); commentList.appendChild(btn);
      }
    }

    function openAllComments(id){
      const arr = comments[id] || [];
      const box = document.getElementById('allCommentsList');
      box.innerHTML = '';
      arr.forEach(c=>{
        const el = document.createElement('div');
        el.className = 'comment'; el.textContent = c.text;
        if (Array.isArray(c.replies)) {
          c.replies.forEach(r=>{
            const rEl = document.createElement('div'); rEl.className='comment comment-reply'; rEl.textContent = '‚Ü≥ ' + r.text;
            el.appendChild(rEl);
          });
        }
        box.appendChild(el);
      });
      document.getElementById('commentsModal').classList.add('open');
    }

    function openLockedInfo(a, distanceMeters){
      document.getElementById('infoTitle').textContent  = a.title || '';
      document.getElementById('infoArtist').textContent = a.artist || '';
      document.getElementById('infoDist').textContent   = (distanceMeters==null) ? 'Distanz: ‚Äì' : `Distanz: ${distanceMeters} m`;
      document.getElementById('infoNeed').textContent   = `Ben√∂tigt: ‚â§ ${a.radius} m`;
      document.getElementById('infoLikes').textContent  = likes[a.id] || 0;

      const wrap = document.getElementById('infoComments');
      wrap.innerHTML = '';
      const arr = comments[a.id] || [];
      const latest = arr.slice(-2);
      if (latest.length === 0) {
        const el = document.createElement('div'); el.className = 'muted'; el.textContent = 'Noch keine Kommentare.';
        wrap.appendChild(el);
      } else {
        latest.forEach(c=>{
          const el = document.createElement('div'); el.className = 'comment'; el.textContent = c.text; wrap.appendChild(el);
        });
      }

      document.getElementById('btnAllComments').onclick = ()=> openAllComments(a.id);
      document.getElementById('btnRoute').onclick = ()=> window.open(`https://www.google.com/maps?q=${a.lat},${a.lon}`, '_blank');
      const claimInfoBtn = document.getElementById('btnClaimInfo');
      claimInfoBtn.onclick = ()=>{
        if (!ownedIds.includes(a.id)) { ownedIds.push(a.id); saveOwned(); renderInbox(); }
        document.getElementById('infoModal').classList.remove('open');
      };

      document.getElementById('infoModal').classList.add('open');
    }

    function openModal(a){
      currentArtwork = a;
      document.getElementById('modal-title').textContent = a.title || '';
      document.getElementById('modal-artist').textContent = a.artist || '';
      document.getElementById('modal-img').src = a.image || 'https://picsum.photos/seed/arthunt/1200/800';
      document.getElementById('modal-desc').textContent = a.description || '';
       // --- AR-Buttons konfigurieren ---
if (a.ar && a.ar.glb) {
  // ‚Äûfreies‚Äú AR (wie bisher)
  btnAr.style.display = 'inline-block';
  btnAr.onclick = () => {
    const url = new URL('ar_basic.html', window.location.href);
    url.searchParams.set('title', a.title || '');
    url.searchParams.set('subtitle', a.artist || '');
    url.searchParams.set('glb', a.ar.glb || '');
    if (a.ar.usdz)  url.searchParams.set('usdz', a.ar.usdz);
    if (a.ar.scale) url.searchParams.set('scale', String(a.ar.scale));
    if (typeof a.ar.rot === 'number') url.searchParams.set('rot', String(a.ar.rot));
    window.location.href = url.toString();
  };

  // Geo-AR (am Ort)
  btnArGeo.style.display = 'inline-block';
  btnArGeo.onclick = () => {
    const url = new URL('geo_ar.html', window.location.href);
    url.searchParams.set('title', a.title || '');
    url.searchParams.set('subtitle', a.artist || '');
    url.searchParams.set('lat', a.lat);
    url.searchParams.set('lon', a.lon);
    url.searchParams.set('model', a.ar.glb || '');
    // etwas kleinere Skala f√ºr AR.js, z.B. 1‚Äì10 statt 100
    const s = a.ar.scale ? (a.ar.scale / 100) : 1;
    url.searchParams.set('scale', String(s));
    window.location.href = url.toString();
  };
} else {
  btnAr.style.display = 'none';
  btnAr.onclick = null;
  btnArGeo.style.display = 'none';
  btnArGeo.onclick = null;
}


      likeCountEl.textContent = likes[a.id] || 0;
      likeBtn.onclick = ()=>{ likes[a.id] = (likes[a.id]||0) + 1; saveLikes(); likeCountEl.textContent = likes[a.id]; };
      shareBtn.onclick = async ()=>{
        const url = location.href.split('#')[0] + '#art=' + encodeURIComponent(a.id);
        if(navigator.share){ try { await navigator.share({ title:a.title, text:a.artist||'ARtHunt', url }); } catch(e){} }
        else { await navigator.clipboard.writeText(url); alert('Link kopiert:\n'+url); }
      };
      if(a.mediaLink){ playBtn.style.display='inline-block'; playBtn.onclick = ()=> window.open(a.mediaLink, '_blank'); }
      else { playBtn.style.display='none'; playBtn.onclick = null; }

      renderComments(a.id);
      commentSend.onclick = ()=>{
        const txt = (commentInput.value||'').trim(); if(!txt) return;
        comments[a.id] = comments[a.id] || []; comments[a.id].push({ text: txt, at: Date.now() }); saveComments();
        commentInput.value=''; renderComments(a.id); renderInbox();
      };
      document.getElementById('btnAllCommentsBig').onclick = ()=> openAllComments(a.id);

      // Creator claim
      if (ownedIds.includes(a.id)) {
        claimBtn.textContent = 'Aus Verwaltung entfernen';
        ownedBadge.style.display = 'inline-block';
        claimBtn.onclick = ()=>{ ownedIds = ownedIds.filter(x=>x!==a.id); saveOwned(); ownedBadge.style.display='none'; renderInbox(); openModal(a); };
      } else {
        claimBtn.textContent = 'Als Creator verwalten';
        ownedBadge.style.display = 'none';
        claimBtn.onclick = ()=>{ ownedIds.push(a.id); saveOwned(); ownedBadge.style.display='inline-block'; renderInbox(); };
      }

      modal.classList.add('open');
    }
    function closeModal(){ modal.classList.remove('open'); } window.closeModal = closeModal;

    // Geolocation
    function onLocation(pos){
      const { latitude, longitude, accuracy } = pos.coords;
      statusEl.textContent = `Standort aktiv ‚Äì ¬±${Math.round(accuracy)} m`;
      if(!userMarker){ userMarker = L.circleMarker([latitude, longitude], { radius: 8, color: '#2563eb', weight: 2, fillColor: '#60a5fa', fillOpacity: 1 }).addTo(map); map.setView([latitude, longitude], 16); }
      else { userMarker.setLatLng([latitude, longitude]); }
      document.getElementById('fCoords').value = latitude.toFixed(6)+', '+longitude.toFixed(6);
      renderList({ lat: latitude, lng: longitude }); checkAutoOpen(latitude, longitude);
    }
    function onLocationError(err){ statusEl.textContent = 'Standortfehler ‚Äì bitte erlauben'; renderList(null); }
    if('geolocation' in navigator){ navigator.geolocation.watchPosition(onLocation, onLocationError, { enableHighAccuracy:true, timeout:10000, maximumAge:5000 }); }
    else { onLocationError(new Error('Geolocation nicht verf√ºgbar')); }

    function checkAutoOpen(lat, lon){
      if(!autoOpenEl.checked) return;
      artworks.forEach(a=>{
        if(unlocked[a.id]) return;
        const d = haversine({lat, lon},{lat:a.lat, lon:a.lon});
        if(d <= a.radius){ tryUnlock(a, {lat, lon}); }
      });
    }

    // Load data
    async function fetchJsonSafe(path){
      try {
        const r = await fetch(path, { cache:'no-store' });
        if(!r.ok) throw new Error('not ok');
        return await r.json();
      } catch(e){ return null; }
    }
    (async ()=>{
      const a = await fetchJsonSafe('artworks.json');
      artworks = a && Array.isArray(a) ? a : DEFAULT_ARTWORKS;
      wireMarkers(); renderList(null);
      const s = await fetchJsonSafe('submissions.json');
      draftsServer = s && Array.isArray(s) ? s : [];
      renderDraftMarkers();
    })();

    // Creator logic
    const fTitle = document.getElementById('fTitle'), fArtist = document.getElementById('fArtist'), fRadius = document.getElementById('fRadius'),
          fCoords = document.getElementById('fCoords'), fDesc = document.getElementById('fDesc'), fImage = document.getElementById('fImage'),
          fMediaLink = document.getElementById('fMediaLink'), imgPreview = document.getElementById('imgPreview'), draftList = document.getElementById('draftList');

    function slugify(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

    fImage.addEventListener('change', ()=>{
      const file = fImage.files?.[0]; if(!file){ imgPreview.textContent='Noch kein Bild ausgew√§hlt.'; return; }
      const reader = new FileReader(); reader.onload = e=>{ imgPreview.innerHTML='<img src="'+e.target.result+'" alt="Preview">'; imgPreview.dataset.dataurl = e.target.result; };
      reader.readAsDataURL(file);
    });

    document.getElementById('btnUseHere').addEventListener('click', ()=>{
      if(userMarker){ const p = userMarker.getLatLng(); fCoords.value = p.lat.toFixed(6)+', '+p.lng.toFixed(6); } else alert('Standort noch nicht aktiv.');
    });

    function renderDrafts(){
      draftList.innerHTML = '';
      draftsLocal.forEach((d,i)=>{
        const el = document.createElement('div'); el.className='item';
        el.innerHTML = '<div style="font-weight:700">'+d.title+'</div>'+
          '<div class="muted" style="margin-bottom:6px">'+(d.artist||'')+' ‚Äì '+d.lat+', '+d.lon+'</div>'+
          (d.image?'<img style="max-width:100%;border-radius:8px" src="'+d.image+'"/>':'')+
          (d.mediaLink?'<div class="chip" style="margin-top:6px">üîó Link: '+d.mediaLink+'</div>':'')+
          '<div style="margin-top:6px;font-size:12px">'+(d.description||'')+'</div>'+
          '<div style="display:flex;gap:6px;margin-top:8px"><button class="btn btn-ghost" data-i="'+i+'">L√∂schen</button></div>';
        draftList.appendChild(el);
        el.querySelector('button').addEventListener('click', ()=>{ draftsLocal.splice(i,1); saveDrafts(); renderDrafts(); renderDraftMarkers(); });
      });
      renderDraftMarkers();
    }
    renderDrafts();

    document.getElementById('btnAdd').addEventListener('click', ()=>{
      const parts = (fCoords.value||'').split(','); const lat = parseFloat((parts[0]||'').trim()); const lon = parseFloat((parts[1]||'').trim());
      if(!fTitle.value || !fArtist.value || isNaN(lat) || isNaN(lon)){ alert('Bitte Titel, K√ºnstler und Koordinaten angeben.'); return; }
      const entry = { id: slugify(fTitle.value)+'-'+Date.now().toString(36).slice(-4), title: fTitle.value, artist: fArtist.value, lat, lon,
        radius: Math.max(10, Math.min(300, parseInt(fRadius.value||'60',10))), image: imgPreview.dataset.dataurl || '', description: fDesc.value || '', mediaLink: (fMediaLink.value||'').trim() };
      draftsLocal.push(entry); saveDrafts(); renderDrafts(); renderDraftMarkers();
      alert('Entwurf gespeichert (lokal). √úber "Als JSON exportieren" kannst du ihn ins Repo √ºbernehmen.');
      fTitle.value=''; fArtist.value=''; fRadius.value='60'; fDesc.value=''; fImage.value=''; imgPreview.textContent='Noch kein Bild ausgew√§hlt.'; delete imgPreview.dataset.dataurl; fMediaLink.value='';
    });

    document.getElementById('btnExport').addEventListener('click', ()=>{
      if(!draftsLocal.length){ alert('Keine Entw√ºrfe vorhanden.'); return; }
      const blob = new Blob([JSON.stringify(draftsLocal, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'submissions.json'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('btnClear').addEventListener('click', ()=>{
      if(confirm('Alle lokalen Entw√ºrfe l√∂schen?')){ draftsLocal = []; saveDrafts(); renderDrafts(); renderDraftMarkers(); }
    });

    // Settings
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; });
    document.getElementById('btnInstallPWA').addEventListener('click', async ()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt = null; } else { alert('Wenn ‚ÄûZum Startbildschirm hinzuf√ºgen‚Äú erscheint, bitte dort nutzen.'); } });
    document.getElementById('btnClearLocal').addEventListener('click', ()=>{
      if(confirm('Alle lokalen Daten (Freischaltungen, Likes, Kommentare, Entw√ºrfe) l√∂schen?')){
        localStorage.removeItem(STORAGE_UNLOCK);
        localStorage.removeItem(STORAGE_DRAFTS);
        localStorage.removeItem(STORAGE_LIKES);
        localStorage.removeItem(STORAGE_COMMENTS);
        localStorage.removeItem(STORAGE_OWNED);
        location.reload();
      }
    });

    // Activity + Inbox
    function renderInbox(){
      const box = document.getElementById('inbox'); if(!box) return;
      box.innerHTML = '';
      let items = [];
      ownedIds.forEach(id=>{
        const arr = comments[id] || [];
        arr.forEach((c, idx)=> items.push({ id, idx, text:c.text, at:c.at }));
      });
      items.sort((a,b)=> (b.at||0)-(a.at||0));
      if(!items.length){ box.innerHTML = '<div class="item muted">Keine Kommentare vorhanden (oder noch keine Werke √ºbernommen).</div>'; return; }
      items.forEach(it=>{
        const aw = artworks.find(x=>x.id===it.id) || draftsLocal.find(x=>x.id===it.id) || draftsServer.find(x=>x.id===it.id) || {title:'Unbekannt', artist:''};
        const el = document.createElement('div'); el.className = 'item';
        const when = it.at ? new Date(it.at).toLocaleString() : '';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
            <div>
              <div style="font-weight:700">${aw.title}</div>
              <div class="muted" style="font-size:12px">${aw.artist||''} ¬∑ ${when}</div>
            </div>
            <button class="btn btn-ghost" data-open>√ñffnen</button>
          </div>
                 <div class="comment-light" style="margin-top:6px">${it.text}</div>
          <div style="display:flex;gap:6px;margin-top:8px;">
            <button class="btn btn-ghost" data-reply>Antworten</button>
            <button class="btn btn-ghost" data-del>L√∂schen</button>
          </div>`;
        el.querySelector('[data-open]').onclick = ()=>{
          const a = artworks.find(x=>x.id===it.id) || draftsLocal.find(x=>x.id===it.id) || draftsServer.find(x=>x.id===it.id);
          if(a){ document.getElementById('drawer').classList.remove('open'); openModal(a);} 
        };
        el.querySelector('[data-reply]').onclick = ()=>{
          const txt = prompt('Antwort schreiben:'); if(!txt) return;
          const arr = comments[it.id] || []; const parent = arr[it.idx];
          if (parent) { if (!Array.isArray(parent.replies)) parent.replies = []; parent.replies.push({ text:'[Creator] '+txt, at: Date.now() }); }
          comments[it.id] = arr; saveComments();
          renderComments(it.id); renderInbox();
        };
        el.querySelector('[data-del]').onclick = ()=>{
          if(!confirm('Diesen Kommentar l√∂schen?')) return;
          comments[it.id].splice(it.idx,1); saveComments(); renderComments(it.id); renderInbox();
        };
        box.appendChild(el);
      });
    }

    function renderActivity(){
      const el = document.getElementById('activity');
      const likeSum = Object.values(likes).reduce((a,b)=>a+b,0);
      const commentSum = Object.values(comments).reduce((a,b)=>a+(Array.isArray(b)?b.length:0),0);
      el.innerHTML = `
        <div class="item"><b>Likes (lokal):</b> ${likeSum}</div>
        <div class="item"><b>Kommentare (lokal):</b> ${commentSum}</div>
        <div class="item"><b>Entw√ºrfe (lokal):</b> ${draftsLocal.length}</div>
        <div class="item"><b>Entw√ºrfe (server):</b> ${draftsServer.length}</div>
      `;
      renderInbox();
    }
    setInterval(renderActivity, 1500);
  </script>
</body>
</html>
