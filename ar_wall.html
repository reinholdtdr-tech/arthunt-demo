<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <title>ARtHunt – Wand-Galerie</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      #hud {
        position: fixed;
        left: 50%;
        bottom: 1.5rem;
        transform: translateX(-50%);
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.7);
        color: #f5f5f5;
        font-size: 0.8rem;
        text-align: center;
        max-width: 90vw;
        z-index: 5;
      }

      #titleBar {
        position: fixed;
        left: 0.75rem;
        right: 0.75rem;
        top: 0.75rem;
        padding: 0.6rem 1rem;
        border-radius: 999px;
        background: linear-gradient(90deg, #141e30, #243b55);
        color: #fff;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        z-index: 5;
      }

      #titleBar span {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #backBtn {
        border: none;
        border-radius: 999px;
        padding: 0.4rem 0.9rem;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.12);
        color: #fff;
        cursor: pointer;
      }
    </style>

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
      // Gleiche Bilder wie im Karussell – Dateinamen müssen im Repo genauso existieren
      const WALL_IMAGES = [
        "20251102_1707_Brücke im Rembrandt-Stil_remix_01k92n2vsqee2rjsqxe12cz19g.png",
        "20251105_2137_Weihnachtslandschaft à la Van Gogh_simple_compose_01k9avpygheafv8mmb9ycav852.png",
        "20251102_1618_Van Gogh Stilbrücke_remix_01k92j85azezrrerbzhgw95hgm.png",
        "20251027_2116_Van Gogh's Prague Impression_simple_compose_01k8kmxe1xefda9a7k536jxjs0 (1).png",
        "20251105_2134_Weihnachtslandschaft à la van Gogh_simple_compose_01k9avhp31fq3affv1c07y74ta.png",
        "20251030_1420_Van Gogh's Charles Bridge_remix_01k8tm9crpedysvyykbpw44a7y.png",
        "20251102_1623_Picasso-Interpretation_remix_01k92jh05me2g9j6prbcntxxfq.png"
      ];

      // ✅ KORRIGIERTE Haversine-Funktion
      function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Erde in m
        const toRad = (v) => (v * Math.PI) / 180;

        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1); // <<< wichtig: lon2 - lon1, nicht lat2 - lon1

        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Entfernung in Metern
      }

      // A-Frame Komponente: Wand-Galerie
      AFRAME.registerComponent("wall-gallery", {
        schema: {
          cols: { type: "number", default: 3 },
          spacing: { type: "number", default: 0.3 },
          planeWidth: { type: "number", default: 2 },
          planeHeight: { type: "number", default: 1.4 },
          height: { type: "number", default: 1.6 }
        },
        init: function () {
          const el = this.el;
          const data = this.data;

          const count = WALL_IMAGES.length;
          const cols = data.cols;
          const rows = Math.ceil(count / cols);

          // Gesamtbreite der Bilder + Abstände
          const totalWidth =
            cols * data.planeWidth + (cols - 1) * data.spacing;
          const totalHeight =
            rows * data.planeHeight + (rows - 1) * data.spacing;

          // Wand hinter den Bildern
          const wall = document.createElement("a-plane");
          wall.setAttribute("width", totalWidth + 1);
          wall.setAttribute("height", totalHeight + 1);
          wall.setAttribute(
            "material",
            "color: #f3f4f6; roughness: 0.9; metalness: 0.0"
          );
          // Wand steht 5 m vor dem Geo-Spot
          wall.setAttribute("position", `0 ${data.height} -5`);
          wall.setAttribute("rotation", "0 0 0");
          el.appendChild(wall);

          // Bilder auf die Wand legen
          for (let i = 0; i < count; i++) {
            const src = WALL_IMAGES[i];
            const row = Math.floor(i / cols);
            const col = i % cols;

            const xOffset =
              -totalWidth / 2 +
              data.planeWidth / 2 +
              col * (data.planeWidth + data.spacing);
            const yOffset =
              totalHeight / 2 -
              data.planeHeight / 2 -
              row * (data.planeHeight + data.spacing);

            const plane = document.createElement("a-plane");
            plane.setAttribute("width", data.planeWidth);
            plane.setAttribute("height", data.planeHeight);
            plane.setAttribute("material", `src: ${src}; side: front`);
            plane.setAttribute(
              "position",
              `${xOffset} ${data.height + yOffset} -4.99`
            );
            plane.setAttribute("rotation", "0 0 0");
            el.appendChild(plane);
          }
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        const hud = document.getElementById("hud");
        const TARGET_LAT = 53.703157;
        const TARGET_LON = 9.983786;

        if ("geolocation" in navigator) {
          navigator.geolocation.watchPosition(
            (pos) => {
              const { latitude, longitude, accuracy } = pos.coords;
              const dist = haversineDistance(
                latitude,
                longitude,
                TARGET_LAT,
                TARGET_LON
              );
              const distRounded = Math.round(dist);
              const accRounded = Math.round(accuracy);

              hud.textContent = `Du bist ca. ${distRounded} m vom Spot entfernt (GPS ± ${accRounded} m). Geh näher heran und schau nach vorne – die Galerie-Wand sollte einige Meter vor dir stehen.`;
            },
            () => {
              hud.textContent =
                "Standort konnte nicht ermittelt werden. Bitte GPS aktivieren und Browser-Berechtigung erteilen.";
            },
            { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
          );
        } else {
          hud.textContent =
            "Dieses Gerät unterstützt keine Geolokation. AR-Galerie kann nicht korrekt ausgerichtet werden.";
        }

        const backBtn = document.getElementById("backBtn");
        backBtn.addEventListener("click", () => {
          if (document.referrer) {
            history.back();
          } else {
            window.location.href = "index.html";
          }
        });
      });
    </script>
  </head>

  <body>
    <div id="titleBar">
      <span>ARtHunt – Wand-Galerie</span>
      <button id="backBtn">Zurück</button>
    </div>
    <div id="hud">Initialisiere AR &amp; Standort…</div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="logarithmicDepthBuffer: true; antialias: true"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <!-- AR-Kamera mit GPS -->
      <a-camera
        id="user-camera"
        gps-camera="simulateAltitude: 0"
        rotation-reader
        position="0 1.6 0"
      ></a-camera>

      <!-- Galerie-Wand am Geo-Spot -->
      <a-entity
        id="wall-root"
        gps-entity-place="latitude: 53.703157; longitude: 9.983786"
        wall-gallery="cols: 3; spacing: 0.3; planeWidth: 2; planeHeight: 1.4; height: 1.8"
      >
      </a-entity>
    </a-scene>
  </body>
</html>
