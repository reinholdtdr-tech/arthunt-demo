<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARtHunt – Norderstedt v2.3 (Creator + Draft-Preview)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    * { box-sizing: border-box; }
    .fab, .fab2 { position: fixed; top: 12px; z-index: 1000; width: 44px; height: 44px; border-radius: 999px;
      background: #111827; color: #fff; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 28px rgba(0,0,0,.18); cursor: pointer; user-select:none; }
    .fab { right: 12px; } .fab2 { right: 62px; }
    .fab span, .fab2 span { font-size: 20px; line-height: 1; }
    .sheet { position: fixed; left: 12px; right: 12px; bottom: 12px; background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px); border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.18);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow: hidden; z-index: 999; }
    .sheet-header { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; cursor:pointer; }
    .pill { width: 40px; height: 5px; border-radius: 999px; background:#e5e7eb; margin: 6px auto; }
    .title { font-weight: 700; font-size: 14px; }
    .muted { color: #6b7280; font-size: 12px; }
    .sheet-body { padding: 8px 10px; display:none; } .sheet.open .sheet-body { display:block; }
    .art-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; }
    .btn { display:inline-block; padding: 8px 10px; border-radius: 8px; font-weight: 600; cursor: pointer; border:0; }
    .btn-primary { background: #111827; color: #fff; } .btn-unlocked { background: #10b981; color: #fff; } .btn-ghost { background: #f3f4f6; color:#111; }
    .badge { display:inline-block; padding:2px 6px; font-size:11px; border-radius: 999px; background:#f3f4f6; }
    .settings { display:flex; gap:8px; align-items:center; justify-content:flex-end; }

    /* Unlock pulse effect */
    .pulse-pin { width: 18px; height: 18px; border-radius: 999px; background: #10b981; border:2px solid #065f46; }
    .pulse-ring { position:absolute; top:-16px; left:-16px; width: 50px; height: 50px; border:2px solid rgba(16,185,129,0.6);
      border-radius: 999px; animation: ring 800ms ease-out forwards; }
    @keyframes ring { from { transform: scale(.1); opacity: .9; } to { transform: scale(1.3); opacity: 0; } }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 1000;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; } .modal.open { display: flex; }
    .modal-card { background: #111; color: #fff; border-radius: 16px; padding: 16px; max-width: min(720px, 92vw); box-shadow: 0 16px 48px rgba(0,0,0,.45); position: relative; }
    .modal-card img { max-width: 100%; border-radius: 12px; display: block; margin: 8px auto; }
    .close { position: absolute; top: 12px; right: 12px; background: #fff; color:#111; border:0; border-radius: 8px; padding: 8px 10px; cursor:pointer; }

    .drawer { position: fixed; top:0; right:0; bottom:0; width: min(480px, 92vw); background:#fff; z-index:1001;
      box-shadow: -8px 0 28px rgba(0,0,0,.25); transform: translateX(100%); transition: transform .25s ease; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .drawer.open { transform: translateX(0); } .drawer header { padding: 12px; display:flex; align-items:center; justify-content:space-between; border-bottom: 1px solid #e5e7eb; }
    .drawer h2 { font-size: 16px; margin:0; } .drawer .content { padding: 12px; overflow:auto; height: calc(100% - 48px); }
    .field { margin-bottom: 10px; } .field label { display:block; font-size:12px; color:#374151; margin-bottom: 4px; }
    .field input, .field textarea { width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .preview { border:1px dashed #e5e7eb; border-radius: 10px; padding:8px; text-align:center; } .preview img { max-width:100%; border-radius:8px; }
    .list { display:grid; gap:10px; } .item { border:1px solid #e5e7eb; padding:8px; border-radius:8px; }
    .legend { position: fixed; left: 12px; top: 12px; z-index: 800; background: rgba(255,255,255,.9); padding:6px 8px; border-radius:10px; font: 12px/1.3 system-ui; }
    .legend b{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:-1px}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="legend">
    <div><b style="background:#ef4444"></b>Live (verschlossen)</div>
    <div><b style="background:#10b981"></b>Live (freigeschaltet)</div>
    <div><b style="background:#93c5fd"></b>Entwürfe (nur lokal)</div>
  </div>

  <div class="fab2" id="menuBtn" title="Creator-Menü"><span>☰</span></div>
  <div class="fab" id="centerBtn" title="Auf mich zentrieren"><span>◎</span></div>

  <div class="sheet" id="sheet">
    <div class="pill"></div>
    <div class="sheet-header" id="toggleSheet">
      <div>
        <div class="title">ARtHunt – Norderstedt</div>
        <div class="muted" id="status">Standort: wird ermittelt…</div>
      </div>
      <div class="settings">
        <label class="muted" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="autoOpen" checked /> Auto-Öffnen vor Ort
        </label>
      </div>
    </div>
    <div class="sheet-body">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="muted">Gefunden:</div><div><span class="badge" id="progress">0 / 0</span></div>
      </div>
      <div id="art-list" style="margin-top:8px; display:grid; gap:8px;"></div>
    </div>
  </div>

  <aside class="drawer" id="drawer">
    <header>
      <h2>Creator-Menü</h2>
      <button class="btn btn-ghost" id="closeDrawer">Schließen</button>
    </header>
    <div class="content">
      <h3 style="margin:6px 0 10px 0;">Neues Werk vor Ort erfassen</h3>
      <div class="field grid2">
        <div><label>Titel</label><input id="fTitle" placeholder="Titel des Werks" /></div>
        <div><label>Künstler</label><input id="fArtist" placeholder="Name oder Kollektiv" /></div>
      </div>
      <div class="field grid2">
        <div><label>Radius (m)</label><input id="fRadius" type="number" min="10" max="300" value="60" /></div>
        <div><label>Koordinaten</label><input id="fCoords" placeholder="Lat, Lon" /></div>
      </div>
      <div class="field"><label>Beschreibung</label><textarea id="fDesc" rows="3" placeholder="Kurze Beschreibung…"></textarea></div>
      <div class="field"><label>Bild (lokal in Base64)</label><input id="fImage" type="file" accept="image/*" /></div>
      <div class="preview" id="imgPreview">Noch kein Bild ausgewählt.</div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="btn btn-primary" id="btnUseHere">Meine aktuelle Position setzen</button>
        <button class="btn btn-unlocked" id="btnAdd">Entwurf speichern</button>
      </div>
      <hr style="margin:14px 0;">
      <h3 style="margin:6px 0 10px 0;">Meine Entwürfe</h3>
      <div class="list" id="draftList"></div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="btn btn-primary" id="btnExport">Als JSON exportieren</button>
        <button class="btn btn-ghost" id="btnClear">Entwürfe löschen</button>
      </div>
      <p class="muted" style="margin-top:8px;">
        Hinweis: Diese Demo speichert Entwürfe nur lokal im Browser (kein Server).<br>
        Lade die exportierte <code>submissions.json</code> in dein GitHub-Repo hoch oder merge die Einträge in <code>artworks.json</code>.
      </p>
    </div>
  </aside>

  <div class="modal" id="modal">
    <div class="modal-card">
      <button class="close" onclick="closeModal()">Schließen</button>
      <div style="font-weight:700;margin-bottom:4px;" id="modal-title"></div>
      <div style="opacity:.8;margin-bottom:6px;" id="modal-artist"></div>
      <img id="modal-img" alt="Artwork" onerror="this.onerror=null;this.src='https://picsum.photos/seed/arthunt/1200/800';" />
      <div id="modal-desc" style="opacity:.9;margin-top:8px;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    const DEFAULT_CENTER = [53.707, 9.996];
    const DEFAULT_ZOOM = 15;
    const STORAGE_UNLOCK = 'arthunt_unlocked_v2_3';
    const STORAGE_DRAFTS = 'arthunt_drafts_v2_3';

    // Fallback-Daten falls artworks.json fehlt
    const DEFAULT_ARTWORKS = [
      { id:'nms', title:'Norderstedt Mitte Rose', artist:'Studio X', lat:53.7067, lon:9.9959, radius:60,
        image:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
        description:'Black stencil grenade with a blooming red rose at Norderstedt Mitte.' },
      { id:'stadtpark', title:'Heartbeat im Stadtpark', artist:'A. Miro', lat:53.7140, lon:10.0060, radius:80,
        image:'https://images.unsplash.com/photo-1496317556649-f930d733eea6?q=80&w=1200&auto=format&fit=crop',
        description:'City skyline morphing into a red heartbeat line near dem See im Stadtpark.' },
      { id:'moorbek', title:'Red Umbrella Moorbekpassage', artist:'Mira K.', lat:53.7080, lon:9.9915, radius:70,
        image:'https://images.unsplash.com/photo-1491955478222-69ae25414368?q=80&w=1200&auto=format&fit=crop',
        description:'Silhouette mit rotem Schirm; rote Tropfen formen Herzen bei der Moorbekpassage.' }
    ];

    let artworks = [];
    const unlocked = JSON.parse(localStorage.getItem(STORAGE_UNLOCK) || '{}');
    let drafts = JSON.parse(localStorage.getItem(STORAGE_DRAFTS) || '[]');

    function saveUnlocks(){ localStorage.setItem(STORAGE_UNLOCK, JSON.stringify(unlocked)); }
    function saveDrafts(){ localStorage.setItem(STORAGE_DRAFTS, JSON.stringify(drafts)); }

    function toRad(d){return d*Math.PI/180;}
    function haversine(a,b){
      const R=6371000;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const la1=toRad(a.lat), la2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }

    // Map
    const map = L.map('map', { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    let userMarker = null;
    const liveLayer = L.layerGroup().addTo(map);
    const draftLayer = L.layerGroup().addTo(map);

    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const autoOpenEl = document.getElementById('autoOpen');
    const list = document.getElementById('art-list');

    document.getElementById('centerBtn').addEventListener('click', ()=>{
      if(userMarker){ map.setView(userMarker.getLatLng(), 16); } else alert('Standort noch nicht aktiv.');
    });

    // Bottom Sheet
    const sheet = document.getElementById('sheet');
    document.getElementById('toggleSheet').addEventListener('click', ()=> sheet.classList.toggle('open'));

    // Drawer
    const drawer = document.getElementById('drawer');
    document.getElementById('menuBtn').addEventListener('click', ()=> drawer.classList.add('open'));
    document.getElementById('closeDrawer').addEventListener('click', ()=> drawer.classList.remove('open'));

    function renderList(userLatLng){
      list.innerHTML = '';
      let found = 0;
      artworks.forEach(a=>{
        const d = (userLatLng ? Math.round(haversine({lat:userLatLng.lat, lon:userLatLng.lng}, {lat:a.lat, lon:a.lon})) : null);
        const isUnlocked = !!unlocked[a.id];
        if(isUnlocked) found++;
        const card = document.createElement('div');
        card.className = 'art-card';
        card.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <div><div style="font-weight:700">${a.title}</div><div style="font-size:12px;color:#666">${a.artist}</div></div>
            <span class="badge">${isUnlocked ? 'Freigeschaltet' : 'Verschlossen'}</span>
          </div>
          <div style="font-size:12px;margin-top:4px">Radius: ${a.radius} m</div>
          <div style="font-size:12px">Entfernung: ${d==null ? '–' : d+' m'}</div>
          <button class="btn ${isUnlocked ? 'btn-unlocked' : 'btn-primary'}" style="margin-top:6px;width:100%">
            ${isUnlocked ? 'Ansehen' : 'Vor Ort freischalten'}
          </button>`;
        list.appendChild(card);
        card.querySelector('button').addEventListener('click', ()=>{
          if(isUnlocked) openModal(a); else tryUnlock(a, userLatLng);
        });
      });
      progressEl.textContent = `${found} / ${artworks.length}`;
    }

    function wireMarkers(){
      liveLayer.clearLayers();
      artworks.forEach(a=>{
        const m = L.circleMarker([a.lat, a.lon], { radius: 7, color: '#111', weight: 2, fillColor: unlocked[a.id] ? '#10b981' : '#ef4444', fillOpacity: 1 }).addTo(liveLayer);
        m.on('click', ()=>{
          if(unlocked[a.id]) openModal(a);
          else if (userMarker) { const p = userMarker.getLatLng(); tryUnlock(a, { lat: p.lat, lon: p.lng }); }
          else alert('Position noch nicht bereit – bitte Standortfreigabe erlauben.');
        });
        a._marker = m;
      });
    }

    function renderDraftMarkers(){
      draftLayer.clearLayers();
      drafts.forEach(d=>{
        const m = L.circleMarker([d.lat, d.lon], { radius: 7, color: '#2563eb', weight: 2, fillColor: '#93c5fd', fillOpacity: 1 }).addTo(draftLayer);
        m.bindTooltip('Entwurf: ' + d.title);
        m.on('click', ()=> openModal({ title:d.title, artist:d.artist, image:d.image, description:d.description }));
      });
    }

    // Drop-signal: pulse + beep
    function unlockEffectAt(lat, lon){
      // Pulse divIcon
      const icon = L.divIcon({ className:'', html:'<div class="pulse-pin"></div><div class="pulse-ring"></div>', iconSize:[18,18], iconAnchor:[9,9] });
      const pin = L.marker([lat, lon], {icon}).addTo(map);
      setTimeout(()=> map.removeLayer(pin), 900);

      // Short beep
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.frequency.value = 880; // A5
        o.type = 'sine';
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
        o.start();
        o.stop(ctx.currentTime + 0.26);
      } catch(e) {}
    }

    function tryUnlock(a, userLatLng){
      if(!userLatLng){ alert('Position noch nicht bereit – bitte Standortfreigabe erlauben.'); return; }
      const dist = haversine({lat:userLatLng.lat, lon:userLatLng.lon || userLatLng.lng},{lat:a.lat, lon:a.lon});
      if(dist <= a.radius){
        unlocked[a.id] = { at: Date.now() }; saveUnlocks();
        if(a._marker) a._marker.setStyle({ fillColor: '#10b981' });
        renderList(userLatLng);
        unlockEffectAt(a.lat, a.lon);
        if(autoOpenEl.checked) openModal(a);
      } else {
        alert('Zu weit weg – '+Math.round(dist)+' m (benötigt ≤ '+a.radius+' m)');
      }
    }

    function checkAutoOpen(lat, lon){
      if(!autoOpenEl.checked) return;
      artworks.forEach(a=>{
        if(unlocked[a.id]) return;
        const d = haversine({lat, lon},{lat:a.lat, lon:a.lon});
        if(d <= a.radius){ tryUnlock(a, {lat, lon}); }
      });
    }

    // Modal
    const modal = document.getElementById('modal');
    function openModal(a){
      document.getElementById('modal-title').textContent = a.title;
      document.getElementById('modal-artist').textContent = a.artist;
      document.getElementById('modal-img').src = a.image || 'https://picsum.photos/seed/arthunt/1200/800';
      document.getElementById('modal-desc').textContent = a.description || '';
      modal.classList.add('open');
    }
    function closeModal(){ modal.classList.remove('open'); } window.closeModal = closeModal;

    // Geolocation
    function onLocation(pos){
      const { latitude, longitude, accuracy } = pos.coords;
      statusEl.textContent = `Standort aktiv – ±${Math.round(accuracy)} m`;
      if(!userMarker){ userMarker = L.circleMarker([latitude, longitude], { radius: 8, color:'#2563eb', weight: 2, fillColor:'#60a5fa', fillOpacity: 1 }).addTo(map); map.setView([latitude, longitude], 16); }
      else { userMarker.setLatLng([latitude, longitude]); }
      document.getElementById('fCoords').value = latitude.toFixed(6)+', '+longitude.toFixed(6);
      renderList({ lat: latitude, lng: longitude }); checkAutoOpen(latitude, longitude);
    }
    function onLocationError(err){ statusEl.textContent = 'Standortfehler – bitte erlauben'; renderList(null); }
    if('geolocation' in navigator){ navigator.geolocation.watchPosition(onLocation, onLocationError, { enableHighAccuracy:true, timeout:10000, maximumAge:5000 }); }
    else { onLocationError(new Error('Geolocation nicht verfügbar')); }

    // Daten laden
    fetch('artworks.json').then(r=>r.ok?r.json():Promise.reject()).then(data=>{ artworks = data; progressEl.textContent = `0 / ${artworks.length}`; wireMarkers(); renderList(null); })
      .catch(()=>{ artworks = DEFAULT_ARTWORKS; progressEl.textContent = `0 / ${artworks.length}`; wireMarkers(); renderList(null); });

    // Creator logic
    const fTitle = document.getElementById('fTitle'), fArtist = document.getElementById('fArtist'), fRadius = document.getElementById('fRadius'),
          fCoords = document.getElementById('fCoords'), fDesc = document.getElementById('fDesc'), fImage = document.getElementById('fImage'),
          imgPreview = document.getElementById('imgPreview'), draftList = document.getElementById('draftList');
    function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

    fImage.addEventListener('change', ()=>{
      const file = fImage.files?.[0]; if(!file){ imgPreview.textContent='Noch kein Bild ausgewählt.'; return; }
      const reader = new FileReader(); reader.onload = e=>{ imgPreview.innerHTML='<img src="'+e.target.result+'" alt="Preview">'; imgPreview.dataset.dataurl = e.target.result; };
      reader.readAsDataURL(file);
    });

    document.getElementById('btnUseHere').addEventListener('click', ()=>{
      if(userMarker){ const p = userMarker.getLatLng(); fCoords.value = p.lat.toFixed(6)+', '+p.lng.toFixed(6); } else alert('Standort noch nicht aktiv.');
    });

    function renderDrafts(){
      draftList.innerHTML = '';
      drafts.forEach((d,i)=>{
        const el = document.createElement('div'); el.className='item';
        el.innerHTML = '<div style="font-weight:700">'+d.title+'</div>'+
          '<div class="muted" style="margin-bottom:6px">'+d.artist+' – '+d.lat+', '+d.lon+'</div>'+
          (d.image?'<img style="max-width:100%;border-radius:8px" src="'+d.image+'"/>':'')+
          '<div style="margin-top:6px;font-size:12px">'+(d.description||'')+'</div>'+
          '<div style="display:flex;gap:6px;margin-top:8px"><button class="btn btn-ghost" data-i="'+i+'">Löschen</button></div>';
        draftList.appendChild(el);
        el.querySelector('button').addEventListener('click', ()=>{ drafts.splice(i,1); saveDrafts(); renderDrafts(); });
      });
      renderDraftMarkers();
    }
    renderDrafts();

    document.getElementById('btnAdd').addEventListener('click', ()=>{
      const parts = fCoords.value.split(','); const lat = parseFloat((parts[0]||'').trim()); const lon = parseFloat((parts[1]||'').trim());
      if(!fTitle.value || !fArtist.value || !lat || !lon){ alert('Bitte Titel, Künstler und Koordinaten angeben.'); return; }
      const entry = { id: slugify(fTitle.value)+'-'+Date.now().toString(36).slice(-4), title: fTitle.value, artist: fArtist.value, lat, lon,
        radius: Math.max(10, Math.min(300, parseInt(fRadius.value||'60',10))), image: imgPreview.dataset.dataurl || '', description: fDesc.value || '' };
      drafts.push(entry); saveDrafts(); renderDrafts();
      alert('Entwurf gespeichert (lokal). Über "Als JSON exportieren" kannst du ihn ins Repo übernehmen.');

      fTitle.value=''; fArtist.value=''; fRadius.value='60'; fDesc.value=''; fImage.value=''; imgPreview.textContent='Noch kein Bild ausgewählt.'; delete imgPreview.dataset.dataurl;
    });

    document.getElementById('btnExport').addEventListener('click', ()=>{
      if(!drafts.length){ alert('Keine Entwürfe vorhanden.'); return; }
      const blob = new Blob([JSON.stringify(drafts, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'submissions.json'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('btnClear').addEventListener('click', ()=>{
      if(confirm('Alle lokalen Entwürfe löschen?')){ drafts = []; saveDrafts(); renderDrafts(); }
    });
  </script>
</body>
</html>
