<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARtHunt – Norderstedt Demo v2</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .sheet {
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      background: rgba(255,255,255,.92); backdrop-filter: blur(8px);
      border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.18);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow: hidden; z-index: 999;
    }
    .sheet-header {
      display:flex; align-items:center; justify-content:space-between; padding:8px 10px; cursor:pointer;
    }
    .pill { width: 40px; height: 5px; border-radius: 999px; background:#e5e7eb; margin: 6px auto; }
    .title { font-weight: 700; font-size: 14px; }
    .muted { color: #6b7280; font-size: 12px; }
    .sheet-body { padding: 8px 10px; display:none; }
    .sheet.open .sheet-body { display:block; }
    .art-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px; }
    .btn { display: inline-block; padding: 8px 10px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #111827; color: #fff; }
    .btn-unlocked { background: #10b981; color: #fff; }
    .badge { display:inline-block; padding:2px 6px; font-size:11px; border-radius: 999px; background:#f3f4f6; }
    .settings { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none;
      align-items: center; justify-content: center; z-index: 1000;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .modal.open { display: flex; }
    .modal-card { background: #111; color: #fff; border-radius: 16px; padding: 16px;
      max-width: min(720px, 92vw); box-shadow: 0 16px 48px rgba(0,0,0,.45); position: relative; }
    .modal-card img { max-width: 100%; border-radius: 12px; display: block; margin: 8px auto; }
    .close { position: absolute; top: 12px; right: 12px; background: #fff; color:#111; border:0; border-radius: 8px; padding: 8px 10px; cursor:pointer; }
    .row { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="sheet" id="sheet">
    <div class="pill"></div>
    <div class="sheet-header" id="toggleSheet">
      <div>
        <div class="title">ARtHunt – Norderstedt</div>
        <div class="muted" id="status">Standort: wird ermittelt…</div>
      </div>
      <div class="settings">
        <label class="muted" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="autoOpen" checked /> Auto-Öffnen vor Ort
        </label>
      </div>
    </div>
    <div class="sheet-body">
      <div class="row"><div class="muted">Gefunden:</div><div><span class="badge" id="progress">0 / 3</span></div></div>
      <div id="art-list" style="margin-top:8px; display:grid; gap:8px;"></div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-card">
      <button class="close" onclick="closeModal()">Schließen</button>
      <div style="font-weight:700;margin-bottom:4px;" id="modal-title"></div>
      <div style="opacity:.8;margin-bottom:6px;" id="modal-artist"></div>
      <img id="modal-img" alt="Artwork" />
      <div id="modal-desc" style="opacity:.9;margin-top:8px;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Startansicht Norderstedt (ungefähre Mitte)
    const DEFAULT_CENTER = [53.707, 9.996];
    const DEFAULT_ZOOM = 15;

    // Beispiel-Orte (Demo)
    const artworks = [
      {
        id: 'nms', title: 'Norderstedt Mitte Rose', artist: 'Studio X',
        lat: 53.7067, lon: 9.9959, radius: 60,
        image: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',
        description: 'Black stencil grenade with a blooming red rose at Norderstedt Mitte.'
      },
      {
        id: 'stadtpark', title: 'Heartbeat im Stadtpark', artist: 'A. Miro',
        lat: 53.7140, lon: 10.0060, radius: 80,
        image: 'https://images.unsplash.com/photo-1496317556649-f930d733eea6?q=80&w=1200&auto=format&fit=crop',
        description: 'City skyline morphing into a red heartbeat line near the See im Stadtpark.'
      },
      {
        id: 'moorbek', title: 'Red Umbrella Moorbekpassage', artist: 'Mira K.',
        lat: 53.7080, lon: 9.9915, radius: 70,
        image: 'https://images.unsplash.com/photo-1491955478222-69ae25414368?q=80&w=1200&auto=format&fit=crop',
        description: 'Silhouette with red umbrella; red drips forming hearts near Moorbekpassage.'
      }
    ];

    // Map
    const map = L.map('map', { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // User location marker
    let userMarker = null;
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');
    const autoOpenEl = document.getElementById('autoOpen');

    // Persistent unlocks
    const STORAGE_KEY = 'arthunt_unlocked_v2';
    const unlocked = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

    // Helpers
    function saveUnlocks(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(unlocked)); }
    function toRad(d){return d*Math.PI/180;}
    function haversine(a,b){
      const R=6371000;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const la1=toRad(a.lat), la2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }

    // Art list
    const list = document.getElementById('art-list');
    function renderList(userLatLng){
      list.innerHTML = '';
      let found = 0;
      artworks.forEach(a=>{
        const d = (userLatLng ? Math.round(haversine({lat:userLatLng.lat, lon:userLatLng.lng}, {lat:a.lat, lon:a.lon})) : null);
        const isUnlocked = !!unlocked[a.id];
        if(isUnlocked) found++;
        const card = document.createElement('div');
        card.className = 'art-card';
        card.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <div>
              <div style="font-weight:700">${a.title}</div>
              <div style="font-size:12px;color:#666">${a.artist}</div>
            </div>
            <span class="badge">${isUnlocked ? 'Freigeschaltet' : 'Verschlossen'}</span>
          </div>
          <div style="font-size:12px;margin-top:4px">Radius: ${a.radius} m</div>
          <div style="font-size:12px">Entfernung: ${d==null ? '–' : d+' m'}</div>
          <button class="btn ${isUnlocked ? 'btn-unlocked' : 'btn-primary'}" style="margin-top:6px;width:100%">
            ${isUnlocked ? 'Ansehen' : 'Vor Ort freischalten'}
          </button>
        `;
        list.appendChild(card);
        card.querySelector('button').addEventListener('click', ()=>{
          if(isUnlocked){
            openModal(a);
          } else {
            tryUnlock(a, userLatLng);
          }
        });
      });
      progressEl.textContent = `${found} / ${artworks.length}`;
    }

    // Map markers
    artworks.forEach(a=>{
      const m = L.circleMarker([a.lat, a.lon], {
        radius: 7, color: '#111', weight: 2, fillColor: unlocked[a.id] ? '#10b981' : '#ef4444', fillOpacity: 1
      }).addTo(map);
      m.on('click', ()=>{
        if(unlocked[a.id]){
          openModal(a);
        } else if (userMarker) {
          const userLatLng = userMarker.getLatLng();
          tryUnlock(a, { lat: userLatLng.lat, lon: userLatLng.lng });
        } else {
          alert('Position noch nicht bereit – bitte Standortfreigabe erlauben.');
        }
      });
      // Update color when unlocked later
      a._marker = m;
    });

    // Unlock logic
    function tryUnlock(a, userLatLng){
      if(!userLatLng){
        alert('Position noch nicht bereit – bitte Standortfreigabe erlauben.');
        return;
      }
      const dist = haversine({lat:userLatLng.lat, lon:userLatLng.lon || userLatLng.lng},{lat:a.lat, lon:a.lon});
      if(dist <= a.radius){
        unlocked[a.id] = { at: Date.now() };
        saveUnlocks();
        if(a._marker) a._marker.setStyle({ fillColor: '#10b981' });
        renderList(userLatLng);
        if(autoOpenEl.checked){ openModal(a); }
      } else {
        alert('Zu weit weg – '+Math.round(dist)+' m (benötigt ≤ '+a.radius+' m)');
      }
    }

    // Modal
    const modal = document.getElementById('modal');
    function openModal(a){
      document.getElementById('modal-title').textContent = a.title;
      document.getElementById('modal-artist').textContent = a.artist;
      document.getElementById('modal-img').src = a.image;
      document.getElementById('modal-desc').textContent = a.description + (unlocked[a.id] ? '' : ' (Demo-Hinweis: Ort vor Ort freischalten)');
      modal.classList.add('open');
    }
    function closeModal(){ modal.classList.remove('open'); }
    window.closeModal = closeModal;

    // Sheet toggle
    const sheet = document.getElementById('sheet');
    document.getElementById('toggleSheet').addEventListener('click', ()=>{
      sheet.classList.toggle('open');
    });

    // Geolocation
    function onLocation(pos){
      const { latitude, longitude, accuracy } = pos.coords;
      statusEl.textContent = `Standort aktiv – ±${Math.round(accuracy)} m`;
      if(!userMarker){
        userMarker = L.circleMarker([latitude, longitude], { radius: 8, color:'#2563eb', weight: 2, fillColor:'#60a5fa', fillOpacity: 1 }).addTo(map);
        map.setView([latitude, longitude], 16);
      } else {
        userMarker.setLatLng([latitude, longitude]);
      }
      renderList({ lat: latitude, lng: longitude });
    }
    function onLocationError(err){
      statusEl.textContent = 'Standortfehler – bitte erlauben';
      renderList(null);
    }
    if('geolocation' in navigator){
      navigator.geolocation.watchPosition(onLocation, onLocationError, { enableHighAccuracy:true, timeout:10000, maximumAge:5000 });
    } else {
      onLocationError(new Error('Geolocation nicht verfügbar'));
    }

    // Initial render with persisted unlocks
    renderList(null);
  </script>
</body>
</html>
