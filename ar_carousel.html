<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <title>ARtHunt – Karussell-Galerie</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      #hud {
        position: fixed;
        left: 50%;
        bottom: 1.5rem;
        transform: translateX(-50%);
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.7);
        color: #f5f5f5;
        font-size: 0.8rem;
        text-align: center;
        max-width: 90vw;
      }

      #titleBar {
        position: fixed;
        left: 0.75rem;
        right: 0.75rem;
        top: 0.75rem;
        padding: 0.6rem 1rem;
        border-radius: 999px;
        background: linear-gradient(90deg, #141e30, #243b55);
        color: #fff;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }

      #titleBar span {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #backBtn {
        border: none;
        border-radius: 999px;
        padding: 0.4rem 0.9rem;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.12);
        color: #fff;
      }
    </style>

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
      // Liste ALLER Bilder im Karussell
      // (Dateien müssen im selben Ordner wie diese HTML liegen)
      const CAROUSEL_IMAGES = [
        "20251102_1707_Brücke im Rembrandt-Stil_remix_01k92n2vsqee2rjsqxe12cz19g.png",
        "20251105_2137_Weihnachtslandschaft à la Van Gogh_simple_compose_01k9avpygheafv8mmb9ycav852.png",
        "20251102_1618_Van Gogh Stilbrücke_remix_01k92j85azezrrerbzhgw95hgm.png",
        "20251027_2116_Van Gogh's Prague Impression_simple_compose_01k8kmxe1xefda9a7k536jxjs0 (1).png",
        "20251105_2134_Weihnachtslandschaft à la van Gogh_simple_compose_01k9avhp31fq3affv1c07y74ta.png",
        "20251030_1420_Van Gogh's Charles Bridge_remix_01k8tm9crpedysvyykbpw44a7y.png",
        "20251102_1623_Picasso-Interpretation_remix_01k92jh05me2g9j6prbcntxxfq.png"
      ];

      // Einfacher Helfer: Entfernung zwischen zwei GPS-Punkten
      function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // m
        const toRad = (v) => (v * Math.PI) / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // A-Frame Komponente: Karussell aufbauen
      AFRAME.registerComponent("carousel-loader", {
        schema: {
          radius: { type: "number", default: 6 },
          height: { type: "number", default: 1.8 },
          planeWidth: { type: "number", default: 2.2 },
          planeHeight: { type: "number", default: 1.5 }
        },
        init: function () {
          const el = this.el;
          const data = this.data;
          const center = document.createElement("a-entity");
          center.setAttribute("id", "carousel-center");
          center.setAttribute("position", `0 ${data.height} 0`);
          el.appendChild(center);

          const count = CAROUSEL_IMAGES.length;
          CAROUSEL_IMAGES.forEach((src, i) => {
            const angle = (i / count) * Math.PI * 2;
            const x = Math.cos(angle) * data.radius;
            const z = Math.sin(angle) * data.radius;

            const plane = document.createElement("a-plane");
            plane.setAttribute("width", data.planeWidth);
            plane.setAttribute("height", data.planeHeight);
            plane.setAttribute("material", `src: url(${src}); side: double`);
            plane.setAttribute("position", `${x} ${data.height} ${z}`);
            // Bilder schauen zum Zentrum des Karussells
            plane.setAttribute("look-at", "#carousel-center");
            el.appendChild(plane);
          });
        }
      });

      // HUD-Aktualisierung (Entfernung zum Spot)
      document.addEventListener("DOMContentLoaded", () => {
        const hud = document.getElementById("hud");
        const TARGET_LAT = 53.703157;
        const TARGET_LON = 9.983786;

        if ("geolocation" in navigator) {
          navigator.geolocation.watchPosition(
            (pos) => {
              const { latitude, longitude, accuracy } = pos.coords;
              const dist = haversineDistance(
                latitude,
                longitude,
                TARGET_LAT,
                TARGET_LON
              );
              const distRounded = Math.round(dist);
              const accRounded = Math.round(accuracy);
              hud.textContent = `Du bist ca. ${distRounded} m vom Spot entfernt (GPS ± ${accRounded} m). Geh näher heran und schau dich um – das Karussell sollte in der Nähe erscheinen.`;
            },
            () => {
              hud.textContent =
                "Standort konnte nicht ermittelt werden. Bitte GPS aktivieren und Browser Berechtigung erteilen.";
            },
            { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
          );
        } else {
          hud.textContent =
            "Dieses Gerät unterstützt keine Geolokation. AR-Karussell kann nicht korrekt ausgerichtet werden.";
        }

        // Back-Button, falls aus deiner Haupt-App verlinkt
        const backBtn = document.getElementById("backBtn");
        backBtn.addEventListener("click", () => {
          if (document.referrer) {
            history.back();
          } else {
            window.location.href = "index.html";
          }
        });
      });
    </script>
  </head>

  <body>
    <div id="titleBar">
      <span>ARtHunt – Karussell-Galerie</span>
      <button id="backBtn">Zurück</button>
    </div>
    <div id="hud">Initialisiere AR &amp; Standort…</div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="logarithmicDepthBuffer: true; antialias: true"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <!-- AR-Kamera mit GPS -->
      <a-camera
        id="user-camera"
        gps-camera="simulateAltitude: 0"
        rotation-reader
        position="0 1.6 0"
      ></a-camera>

      <!-- Karussell am Geo-Spot -->
      <a-entity
        id="carousel-root"
        gps-entity-place="latitude: 53.703157; longitude: 9.983786"
        carousel-loader="radius: 7; height: 2; planeWidth: 2.4; planeHeight: 1.7"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 90000; easing: linear"
      >
      </a-entity>
    </a-scene>
  </body>
</html>
